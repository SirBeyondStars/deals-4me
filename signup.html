<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deals-4Me – Sign Up</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.fade-swap{transition:opacity 700ms ease}</style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="min-h-screen grid grid-cols-1 md:grid-cols-2">
    <!-- LEFT: Circulars images -->
    <aside class="relative hidden md:block">
      <div class="absolute inset-0 bg-gradient-to-br from-rose-200 via-amber-100 to-sky-100"></div>
      <div class="absolute inset-0 overflow-hidden">
        <img id="sA" class="fade-swap absolute inset-0 w-full h-full object-cover opacity-100" src="images/circular1.jpg" alt="Deals preview A" />
        <img id="sB" class="fade-swap absolute inset-0 w-full h-full object-cover opacity-0"   src="images/circular2.jpg" alt="Deals preview B" />
      </div>
      <div class="absolute bottom-6 left-6 bg-white/80 backdrop-blur rounded-xl px-4 py-3 shadow">
        <h2 class="text-lg font-semibold text-gray-800">Save on Weekly Essentials</h2>
        <p class="text-sm text-gray-600">Groceries, household, electronics & more.</p>
      </div>
    </aside>

    <!-- RIGHT: Signup card -->
    <main class="flex items-center justify-center p-6">
      <div class="w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <div class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-rose-600">Deals‑4Me</h1>
            <p class="text-gray-500 text-sm">Create your account</p>
          </div>

          <form id="signupForm" class="space-y-4">
            <!-- Email / Password -->
            <div>
              <label class="block text-sm font-medium text-gray-700">Email</label>
              <input id="email" type="email" required
                     class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Password</label>
                <input id="password" type="password" required
                       class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Confirm Password</label>
                <input id="password2" type="password" required
                       class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
              </div>
            </div>

            <!-- Address -->
            <div>
              <label class="block text-sm font-medium text-gray-700">Address Line 1</label>
              <input id="addr1" type="text" required placeholder="123 Main St"
                     class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Address Line 2 (optional)</label>
              <input id="addr2" type="text" placeholder="Apt / Unit"
                     class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">City</label>
                <input id="city" type="text" required
                       class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">State</label>
                <input id="state" type="text" maxlength="2" required placeholder="MA"
                       class="mt-1 w-full uppercase border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">ZIP Code</label>
              <input id="zip" type="text" inputmode="numeric" maxlength="10" required placeholder="02108"
                     class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
            </div>

            <!-- 4-digit PIN -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">4‑digit PIN</label>
                <input id="pin" type="password" inputmode="numeric" maxlength="4" required placeholder="••••"
                       class="mt-1 w-full tracking-widest text-center text-xl border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Confirm PIN</label>
                <input id="pin2" type="password" inputmode="numeric" maxlength="4" required placeholder="••••"
                       class="mt-1 w-full tracking-widest text-center text-xl border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-400" />
              </div>
            </div>

            <!-- Terms -->
            <label class="inline-flex items-center text-sm text-gray-600">
              <input id="agree" type="checkbox" class="mr-2" required />
              I agree to the <a class="text-rose-600 underline ml-1" href="terms.html" target="_blank">Terms of Service</a> and
              <a class="text-rose-600 underline ml-1" href="privacy.html" target="_blank">Privacy Policy</a>.
            </label>

            <!-- Submit -->
            <button id="btnSignup" type="submit"
                    class="w-full bg-rose-600 hover:bg-rose-700 text-white font-semibold py-2 rounded-lg mt-2">
              Create Account
            </button>
            <p id="error" class="text-sm text-red-600 mt-2 hidden"></p>
          </form>

          <p class="text-center text-sm text-gray-600 mt-4">
            Already have an account?
            <a class="text-rose-600 hover:text-rose-700 underline" href="login.html">Log in</a>
          </p>
        </div>
        <p class="text-center text-xs text-gray-400 mt-4">© 2025 Deals‑4Me</p>
      </div>
    </main>
  </div>

  <!-- Redirect signed-in users away from signup -->
  <script src="scripts/auth-redirect.js"></script>

  <!-- Firebase + Sign-up Logic -->
  <script type="module">
    // Slideshow
    const pics = ["images/circular1.jpg","images/circular2.jpg","images/circular3.jpg"];
    const sA = document.getElementById('sA'), sB = document.getElementById('sB');
    let i=0, showA=true;
    setInterval(()=>{
      const next = pics[(i+1)%pics.length];
      if (showA){ sB.src=next; sB.style.opacity=1; sA.style.opacity=0; }
      else { sA.src=next; sA.style.opacity=1; sB.style.opacity=0; }
      i=(i+1)%pics.length; showA=!showA;
    }, 4000);

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCL76t1c3F315zxjoeDHUif1SCRILwLB-k",
      authDomain: "deals-4me-24e59.firebaseapp.com",
      projectId: "deals-4me-24e59",
      storageBucket: "deals-4me-24e59.firebasestorage.app",
      messagingSenderId: "371824876408",
      appId: "1:371824876408:web:6835492135efd123a7468d",
      measurementId: "G-9BR1V8ETC6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const errEl = $('error');
    const show = (el)=>el.classList.remove('hidden'), hide=(el)=>el.classList.add('hidden');
    function norm(str){return (str||"").trim().toLowerCase().replace(/\s+/g," ").replace(/[.,#]/g,"");}
    function householdKey(line1, zip){ return `${norm(line1)}|${(zip||"").trim()}`; }
    const fourPin = (p)=>/^[0-9]{4}$/.test(p);
    async function sha256Hex(input){ const enc=new TextEncoder().encode(input); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

    // capture ?next= to forward it to login after signup
    const params = new URLSearchParams(location.search);
    const nextAfter = params.get('next') || 'index.html';

    $('signupForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); hide(errEl);

      const email=$('email').value.trim();
      const pw=$('password').value, pw2=$('password2').value;
      const addr1=$('addr1').value, addr2=$('addr2').value, city=$('city').value, state=$('state').value.toUpperCase(), zip=$('zip').value;
      const pin=$('pin').value, pin2=$('pin2').value;

      if(pw!==pw2){ errEl.textContent="Passwords do not match."; show(errEl); return; }
      if(!fourPin(pin) || pin!==pin2){ errEl.textContent="PINs must match and be exactly 4 digits."; show(errEl); return; }
      if(!$('agree').checked){ errEl.textContent="Please accept the Terms to continue."; show(errEl); return; }

      try{
        // Enforce single main account per address
        const key=householdKey(addr1, zip);
        const q=query(collection(db,"users"), where("householdKey","==",key));
        const ex=await getDocs(q);
        if(!ex.empty){
          errEl.innerHTML="An account already exists for this address.<br/>Please have the main account holder add you as a family member.";
          show(errEl); return;
        }

        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        await updateProfile(cred.user, { displayName: email.split('@')[0] });

        await setDoc(doc(db,"users",cred.user.uid), {
          email,
          tier: "basic",
          pinHash: await sha256Hex(pin),
          address: { line1: addr1, line2: addr2, city, state, zip },
          householdKey: key,
          role: "owner",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        // send them to login and preserve intended destination via ?next=
        const encodedNext = encodeURIComponent(nextAfter);
        window.location.href = `login.html?next=${encodedNext}`;
      }catch(err){
        console.error(err);
        errEl.textContent = err?.message || "Sign-up failed.";
        show(errEl);
      }
    });
  </script>
</body>
</html>
