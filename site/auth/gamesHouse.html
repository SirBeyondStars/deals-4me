<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="./styles/theme.css">
<link rel="stylesheet" href="./styles/toolbarTheme.css">
</head>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Games â€” House Map (Starter)</title>
  <style>
    :root{
      --bg:#f8fafc; --fg:#0f172a; --muted:#64748b;
      --wall:#F4F1ED; --trim:#E2D6C4; --wood:#C49A6C; --tile:#D6D3D0; --gold:#C9A227;
      --fabric-green:#A9C9A4; --fabric-blue:#93B7BE; --rug-red:#C97B7B; --rug-gold:#E5C07B;
      --kitchen:#E8F5E9; --bedroom:#F0E6F6; --garage:#D9DEE2; --garden:#E1F0D4;
      --card:#ffffff; --line:#e5e7eb; --shadow: 0 6px 20px rgba(2,6,23,.08);
      --radius:16px;
    }
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .toolbar{position:sticky;top:0;z-index:50;background:#0f172a;color:#e2e8f0;padding:12px 16px;box-shadow:0 1px 0 #0b1220;transition:transform .18s ease}
.toolbar.hidden{transform:translateY(-100%)}
/* reveal hit area when toolbar is hidden */
.toolbar-reveal-zone{position:fixed;top:0;left:0;right:0;height:16px;z-index:40;pointer-events:auto}
    .lp-banner{margin:12px auto;padding:10px 12px;border-radius:12px;max-width:1100px;
      background:var(--kitchen);color:var(--fg);display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      box-shadow:0 1px 4px rgba(0,0,0,.06)}
    .lp-banner button{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:999px;font-size:12px}
    main{max-width:1100px;margin:16px auto 40px;padding:0 12px}
    .page-head{display:flex;align-items:end;justify-content:space-between;gap:12px;margin:8px 0 6px}
    .page-title{font-weight:800;letter-spacing:.2px}
    .points-chip{font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff}
    .map-wrap{position:relative;background:var(--wall);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;min-height:520px;margin-bottom:20px}
    .map-floor{position:absolute;inset:auto 0 0 0;height:90px;background:
      linear-gradient(transparent,rgba(0,0,0,.02)),
      repeating-linear-gradient(90deg, #b37f4f 0 12px, #c18b57 12px 24px);
      border-top:2px solid rgba(0,0,0,.05)}
    .room{position:absolute;border:1px solid rgba(0,0,0,.08);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05);
      padding:10px; cursor:pointer; outline:none; transition:transform .15s ease, box-shadow .15s ease}
    .room:hover, .room:focus{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.12)}
    .room h3{margin:0 0 8px;font-size:14px}
    .room p{margin:0;font-size:12px;color:var(--muted)}
    .room.locked{filter:saturate(.3) brightness(.95)}
    .room.locked::after{content:"ðŸ”’";position:absolute;top:8px;right:10px;font-size:14px}
    .room.kitchen{background:var(--kitchen)}
    .room.bedroom{background:var(--bedroom)}
    .room.garage{background:var(--garage)}
    .room.garden{background:var(--garden)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{background:var(--card);border-radius:16px;max-width:560px;width:100%;box-shadow:var(--shadow);
      border:1px solid var(--line)}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .modal header h4{margin:0;font-size:16px}
    .modal .body{padding:14px 16px;font-size:14px;color:#0f172a}
    .modal .body ul{padding-left:18px;margin:8px 0}
    .modal footer{padding:12px 16px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid var(--line)}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:#0f172a;color:#e2e8f0;border-color:#0f172a}
    @media (min-width: 840px){
      .room.kitchen{left:40px;top:40px;width:280px;height:160px}
      .room.bedroom{left:360px;top:40px;width:280px;height:140px}
      .room.garage{left:40px;top:230px;width:260px;height:140px}
      .room.garden{left:330px;top:210px;width:320px;height:160px}
    }
    @media (max-width: 839px){
      .map-wrap{min-height:620px}
      .room{left:20px;right:20px}
      .room.kitchen{top:24px}
      .room.bedroom{top:190px}
      .room.garage{top:340px}
      .room.garden{top:490px}
    }
  </style>
</head>
<body>
  <header class="toolbar" role="banner">
    <strong>Dealsâ€‘4Me</strong> â€¢ Games
  </header>
  <div class="lp-banner" role="status">
    ðŸŽ® LPs are for fun right now â€” <strong>no cash value</strong>. Rewards may come later.
    <button type="button" id="lpLearnBtn" aria-haspopup="dialog" aria-controls="lpModal">Learn more</button>
  </div>
  <main>
    <div class="page-head">
      <div>
        <h1 class="page-title">Games House</h1>
        <div style="font-size:13px;color:var(--muted)">Tap a room to explore. Some rooms are locked until activated.</div>
      </div>
      <div class="points-chip" id="pointsChip" title="Play mode â€” no cash value">LP: <strong>1,240</strong></div>
    </div>
    <section class="map-wrap" aria-label="House map">
      <div class="map-floor" aria-hidden="true"></div>
      <button class="room kitchen" data-room="cooking">
        <h3>Cooking with Mom &amp; Dad</h3>
        <p>Use recipes from your recipe box â€¢ Family LP</p>
      </button>
      <button class="room bedroom locked" data-room="bedroom">
        <h3>Bedroom</h3>
        <p>Timed tidy challenges â€¢ Unlock soon</p>
      </button>
      <button class="room garage locked" data-room="garage">
        <h3>Garage</h3>
        <p>Sort &amp; organize â€¢ Coming event</p>
      </button>
      <button class="room garden" data-room="garden">
        <h3>Garden</h3>
        <p>Plant care &amp; watering quests</p>
      </button>
    </section>
    <div id="game-mount" style="display:none; padding:12px; background:#fff; border-radius:12px; box-shadow:var(--shadow)"></div>
      <!-- External Game Mount (hidden until a room opens a game) -->
    <section class="game-area" id="gameArea" aria-label="Game player">
      <div class="game-head">
        <strong id="gameTitle">Loadingâ€¦</strong>
        <div>
          <button class="game-back" id="closeGameBtn" aria-label="Close game and return to map">Back to House</button>
        </div>
      </div>
      <div id="game-mount" role="region" aria-live="polite"></div>
    </section>
  </main>
  <!-- small strip to reveal toolbar on hover/mousemove when hidden -->
  <div class="toolbar-reveal-zone" id="toolbarRevealZone" aria-hidden="true"></div>
  <div class="modal-backdrop" id="lpModal" role="dialog" aria-modal="true">
    <div class="modal">
      <header>
        <h4>About Life Points (LPs)</h4>
        <button class="btn" id="lpClose">âœ•</button>
      </header>
      <div class="body">
        <p><strong>LPs are play-only right now.</strong></p>
        <ul>
          <li>No cash value; not redeemable yet.</li>
          <li>We may introduce sponsors later with a conversion plan.</li>
          <li>Balances may change if we fix bugs or abuse.</li>
        </ul>
        <p>Status: <code id="lpModeText">play</code></p>
      </div>
      <footer>
        <button class="btn primary" id="lpOk">Got it</button>
      </footer>
    </div>
  </div>
  <script>
    const lpMode = { status: 'play' };
    document.getElementById('lpModeText').textContent = lpMode.status;
    const lpModal = document.getElementById('lpModal');
    document.getElementById('lpLearnBtn').onclick = () => { lpModal.style.display = 'flex'; };
    document.getElementById('lpClose').onclick = () => { lpModal.style.display = 'none'; };
    document.getElementById('lpOk').onclick = () => { lpModal.style.display = 'none'; };
    lpModal.onclick = (e) => { if(e.target === lpModal) lpModal.style.display = 'none'; };

   // Game registry loader
window.D4M = {
  _init: true,
  games: {},
  register(id, cfg) { this.games[id] = cfg; },
  async open(id, options = {}) {
    const mount = document.getElementById('game-Mount');
    mount.innerHTML = '<div style="padding:20px">Loading...</div>';

    // Special case for Cooking with Mom & Dad
    if (id === 'cooking') {
      try {
        const res = await fetch('data/recipes.json?v=' + Date.now(), { cache: 'no-store' });
        const recipes = await res.json();

        // Build recipe list
        let html = `<h2>Select a Recipe</h2><ul style="list-style:none;padding:0;">`;
        recipes.forEach(r => {
          html += `<li style="margin-bottom:10px;">
            <button style="padding:10px 14px;border:1px solid #ccc;border-radius:6px;cursor:pointer;">
              ${r.title} (${r.estMinutes} min)
            </button>
          </li>`;
        });
        html += `</ul>`;
        mount.innerHTML = html;
      } catch (err) {
        console.error(err);
        mount.innerHTML = `<div style="padding:12px;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:10px">
          Couldnâ€™t load recipes. Check <code>/data/recipes.json</code> path.
        </div>`;
      }
      return;
    }

    // Default loader for other games
    const cfg = this.games[id];
    if (!cfg) {
      mount.innerHTML = '<div style="padding:20px;color:#b91c1c">Game not found</div>';
      return;
    }
    if (cfg.type === 'markup') {
      mount.innerHTML = cfg.markup;
    } else if (cfg.type === 'iframe') {
      mount.innerHTML = `<iframe src="${cfg.url}" style="width:100%;height:500px;border:none;border-radius:10px;"></iframe>`;
    }
  }
};


    // Example game registration
    D4M.register('cooking', { type:'markup', url:'/games/cooking.html' , title:'Cooking with Mom & Dad'});

    document.querySelectorAll('.room').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.room;
        if(btn.classList.contains('locked')){
          toast('This room is locked.');
          return;
        }
        D4M.open(id);
      });
    });

    function toast(text){
      const t = document.createElement('div');
      t.textContent = text;
      t.style.cssText = 'position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;z-index:60';
      document.body.appendChild(t);
      requestAnimationFrame(()=>{ t.style.transition='opacity .18s ease'; t.style.opacity='1'; });
      setTimeout(()=>{ t.style.opacity='0'; t.addEventListener('transitionend',()=>t.remove(),{once:true}); }, 1800);
    }
  

    // ---------- Game Registry / Loader (appended) ----------
    (function(){
      if(window.D4M && window.D4M.__init) return; // avoid double init
      window.D4M = {
        __init:true,
        games:{}, // id -> { type: 'markup'|'module'|'iframe', url, title?, props? }
        register(id,cfg){ this.games[id]=cfg; },
        async open(id){
          const cfg=this.games[id];
          if(!cfg){ toast(`Game not found: ${id}`); return; }
          const mount=document.getElementById('game-mount');
          const area=document.getElementById('gameArea');
          const titleEl=document.getElementById('gameTitle');
          mount.innerHTML='';
          titleEl.textContent = cfg.title || 'Game';
          try{
            if(cfg.type==='markup'){
              const res=await fetch(cfg.url,{cache:'no-store'});
              const html=await res.text();
              mount.innerHTML=html;
              // re-execute scripts from fetched markup
              mount.querySelectorAll('script').forEach(old=>{
                const s=document.createElement('script');
                if(old.src){ s.src=old.src; s.defer=old.defer; }
                else{ s.textContent=old.textContent; }
                mount.appendChild(s); old.remove();
              });
            } else if(cfg.type==='module'){
              const mod=await import(cfg.url);
              await mod.mount?.(mount,cfg.props||{});
            } else if(cfg.type==='iframe'){
              const f=document.createElement('iframe');
              f.src=cfg.url; f.sandbox=cfg.sandbox||'allow-scripts allow-same-origin';
              f.style='width:100%;height:600px;border:0;border-radius:12px;';
              mount.appendChild(f);
            }
            area.style.display='block';
            area.scrollIntoView({behavior:'smooth',block:'start'});
          }catch(err){ console.error(err); toast('Failed to load game.'); }
        }
      };

      // Example registrations (replace with your real files)
      window.D4M.register('cooking', { type:'markup', url:'/games/cooking.html', title:'Cooking with Mom & Dad' });
      window.D4M.register('egg-crack', { type:'module', url:'/games/eggCrack.js', title:'Egg Crack Challenge' });
      window.D4M.register('vendor-math', { type:'iframe', url:'https://partner.example/match-game', title:'Vendor Math' });

      // Close game button
      const closeBtn=document.getElementById('closeGameBtn');
      if(closeBtn){ closeBtn.addEventListener('click',()=>{
        document.getElementById('gameArea').style.display='block';
        document.getElementById('game-mount').innerHTML='';
        document.getElementById('gameTitle').textContent='Loadingâ€¦';
        toast('Returned to house map');
      }); }

      // Rewire room buttons: remove previous click handlers and attach loader
      const mapRooms=document.querySelectorAll('.room');
      const ROOM_TO_GAME={ kitchen:'cooking', garden:'vendor-math', bedroom:null, garage:null };
      mapRooms.forEach(btn=>{
        const clone=btn.cloneNode(true);
        btn.replaceWith(clone);
        clone.addEventListener('click',()=>{
          const id=clone.dataset.room;
          if(clone.classList.contains('locked')){
            clone.animate([{transform:'translateY(0)'},{transform:'translateY(-2px)'},{transform:'translateY(0)'}],{duration:180,easing:'ease-out'});
            const msg=id==='bedroom'?'Unlock at Level 2':'Locked for now';
            toast(`${clone.querySelector('h3').textContent}: ${msg}`);
            return;
          }
          const gameId=ROOM_TO_GAME[id];
          if(!gameId){ toast('No game assigned yet.'); return; }
          window.D4M.open(gameId);
        });
        clone.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); clone.click(); } });
      });
    })();

  

    // -------- Toolbar auto-hide while inside a room --------
    const toolbar = document.querySelector('.toolbar');
    const revealZone = document.getElementById('toolbarRevealZone');
    function autoHideToolbar(active){
      if(active){ toolbar.classList.add('hidden'); }
      else { toolbar.classList.remove('hidden'); }
    }
    // reveal when mouse nears top, or on Escape key
    window.addEventListener('mousemove', (e)=>{
      if(e.clientY <= 16) toolbar.classList.remove('hidden');
    });
    revealZone.addEventListener('mouseenter', ()=> toolbar.classList.remove('hidden'));
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toolbar.classList.remove('hidden'); });

    // -------- Recipe Picker for Kitchen --------
    async function renderRecipePicker(mount, cfg){
      // UI shell
      const wrap=document.createElement('div');
      wrap.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 12px">
          <div>
            <h2 style="margin:0 0 4px">Cooking with Mom & Dad</h2>
            <div style="font-size:13px;color:var(--muted)">Pick a family-friendly recipe to start. (Playâ€‘mode LP only)</div>
          </div>
          <div>
            <input id="recipeSearch" placeholder="Search recipes" style="padding:8px 10px;border:1px solid var(--line);border-radius:10px"/>
          </div>
        </div>
        <div id="recipeList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px"></div>
      `;
      mount.appendChild(wrap);

      // fetch recipes (expects a JSON array). Filter by tag family_cook if present
      let recipes=[];
      try{
        const res = await fetch('data/recipes.json', { cache: 'no-store' });


        recipes = await res.json();
      }catch(_){ recipes = []; }
      const filtered = recipes.filter(r => !r.tags || r.tags.includes('family_cook'));
      const list = wrap.querySelector('#recipeList');

      function draw(listData){
        list.innerHTML='';
        (listData.length? listData: [{id:'sample-apple-muffins', title:'Apple Muffins (Sample)', estMinutes:35, tags:['family_cook','kid_friendly']}]).forEach(r=>{
          const card=document.createElement('button');
          card.className='recipe-card';
          card.style.cssText='text-align:left;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,.05)';
          card.innerHTML=`<div style="font-weight:600">${r.title}</div>
            <div style="font-size:12px;color:var(--muted)">${r.estMinutes? r.estMinutes+ ' min â€¢ ': ''}${(r.tags||[]).slice(0,2).join(' â€¢ ')}</div>`;
          card.addEventListener('click', async ()=>{
            toast(`Loading ${r.title}â€¦`);
            // launch actual cooking game module/markup; pass recipeId if supported
            if(cfg.type==='module'){
              const mod = await import(cfg.url);
              await mod.mount?.(mount, { ...(cfg.props||{}), recipeId: r.id });
            } else if(cfg.type==='markup'){
              // Fallback: navigate to a dedicated page with ?id= param
              location.href = `/games/cooking.html?id=${encodeURIComponent(r.id)}`;
            }
          });
          list.appendChild(card);
        });
      }
      draw(filtered);

      wrap.querySelector('#recipeSearch').addEventListener('input', (e)=>{
        const q=e.target.value.toLowerCase();
        draw(filtered.filter(r=> (r.title||'').toLowerCase().includes(q)));
      });
    }

    // Keep Back button closing the room and restoring toolbar
    const closeBtn=document.getElementById('closeGameBtn');
    if(closeBtn){ closeBtn.addEventListener('click',()=>{
      document.getElementById('gameArea').style.display='none';
      document.getElementById('game-mount').innerHTML='';
      document.getElementById('gameTitle').textContent='Loadingâ€¦';
      autoHideToolbar(false);
      toast('Returned to house map');
    }); }

  </script>
</body>
</html>
